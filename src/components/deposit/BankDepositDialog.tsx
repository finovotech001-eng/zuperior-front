"use client";

import React, { useState, useEffect, useCallback } from "react";
import { Dialog, DialogContent, DialogTitle, DialogHeader } from "@/components/ui/dialog";
import { VisuallyHidden } from "@radix-ui/react-visually-hidden";
import { USDTManualStep1Form } from "./USDTManualStep1Form";
import { WireStep2Instructions } from "./WireStep2Instructions";
import { USDTManualStep3Transaction } from "./USDTManualStep3Transaction";
import { USDTManualStep4Confirmation } from "./USDTManualStep4Confirmation";
import { useSelector, useDispatch } from "react-redux";
import type { RootState, AppDispatch } from "../../store";
import { fetchUserAccountsFromDb } from "../../store/slices/mt5AccountSlice";

export function BankDepositDialog({ open, onOpenChange, lifetimeDeposit }: { open: boolean; onOpenChange: (v: boolean)=>void; lifetimeDeposit: number; }) {
  const [step, setStep] = useState(1);
  const [amount, setAmount] = useState("");
  const [selectedAccount, setSelectedAccount] = useState("");
  const [transactionId, setTransactionId] = useState("");
  const [proofFile, setProofFile] = useState<File | null>(null);
  const [depositRequestId, setDepositRequestId] = useState("");
  const [bank, setBank] = useState<any>(null);

  const dispatch = useDispatch<AppDispatch>();
  const mt5Accounts = useSelector((state: RootState) => state.mt5.accounts);
  const filteredAccounts = mt5Accounts.filter(acc => String(acc.accountId || '').trim() && String(acc.accountId).trim() !== '0');

  useEffect(() => {
    if (open && mt5Accounts.length === 0) dispatch(fetchUserAccountsFromDb() as any);
  }, [open, dispatch, mt5Accounts.length]);

  useEffect(() => {
    if (!open) return;
    (async () => {
      try {
        const token = typeof window !== 'undefined' ? localStorage.getItem('userToken') : null;
        const res = await fetch('/api/manual-gateway?type=wire', {
          cache: 'no-store',
          headers: token ? { 'Authorization': `Bearer ${token}` } : undefined,
        });
        const data = await res.json();
        if (data?.success) {
          const raw = data?.data?.bank || data?.data || {};
          // Normalize keys in case backend returns snake_case
          const normalized = {
            bankName: raw.bankName ?? raw.bank_name ?? null,
            accountName: raw.accountName ?? raw.account_name ?? null,
            accountNumber: raw.accountNumber ?? raw.account_number ?? null,
            ifscCode: raw.ifscCode ?? raw.ifsc_code ?? null,
            swiftCode: raw.swiftCode ?? raw.swift_code ?? null,
            accountType: raw.accountType ?? raw.account_type ?? null,
            countryCode: raw.countryCode ?? raw.country_code ?? null,
          };
          setBank(normalized);
        } else {
          setBank(null);
        }
      } catch (e) {
        console.error('Failed to fetch manual gateway:', e);
        setBank(null);
      }
    })();
  }, [open]);

  const reset = useCallback(() => {
    setStep(1); setAmount(""); setSelectedAccount(""); setTransactionId(""); setProofFile(null); setDepositRequestId("");
  }, []);

  useEffect(() => { if (!open) reset(); }, [open, reset]);

  const handleCreate = async () => {
    // Uses existing manual deposit endpoint and proxy
    const formData = new FormData();
    formData.append('mt5AccountId', selectedAccount);
    formData.append('amount', amount);
    if (transactionId) formData.append('transactionHash', transactionId);
    if (proofFile) formData.append('proofFile', proofFile);

    const token = localStorage.getItem('userToken') || '';
    const response = await fetch('/api/manual-deposit/create', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData });
    const result = await response.json();
    if (result?.success) { setDepositRequestId(result.data.id); setStep(4); }
  };

  const renderStep = () => {
    switch (step) {
      case 1:
        return (
          <USDTManualStep1Form
            amount={amount}
            setAmount={setAmount}
            selectedAccount={selectedAccount}
            setSelectedAccount={setSelectedAccount}
            accounts={filteredAccounts}
            lifetimeDeposit={lifetimeDeposit}
            nextStep={() => setStep(2)}
          />
        );
      case 2:
        return (
          <WireStep2Instructions bank={bank || {}} amount={amount} nextStep={() => setStep(3)} />
        );
      case 3:
        return (
          <USDTManualStep3Transaction
            amount={amount}
            selectedAccount={selectedAccount}
            transactionId={transactionId}
            setTransactionId={setTransactionId}
            proofFile={proofFile}
            setProofFile={setProofFile}
            nextStep={handleCreate}
            isProcessing={false}
            variant="bank"
          />
        );
      case 4:
        return (
          <USDTManualStep4Confirmation
            amount={amount}
            selectedAccount={selectedAccount}
            transactionId={transactionId}
            depositRequestId={depositRequestId}
            onClose={() => onOpenChange(false)}
            bank={bank || {}}
          />
        );
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-[95vw] sm:max-w-[95%] lg:max-w-2xl gap-4 bg-background shadow-lg border-2 border-transparent p-6 text-white rounded-[18px] flex flex-col items-center w-full max-h-[90vh] overflow-y-auto [background:linear-gradient(#fff,#fff)_padding-box,conic-gradient(from_var(--border-angle),#ddd,#f6e6fc,theme(colors.purple.400/48%))_border-box] dark:[background:linear-gradient(#070206,#030103)_padding-box,conic-gradient(from_var(--border-angle),#030103,#030103,color-mix(in_oklab,oklch(71.4%_0.203_305.504)_48%,transparent))_border-box] animate-border">
        <VisuallyHidden><DialogTitle>Wire Transfer</DialogTitle></VisuallyHidden>
        {/* Stepper header to match USDT dialog */}
        <DialogHeader className="w-full py-3">
          <div className="flex items-center justify-between w-full pt-2">
            <div className="flex items-center space-x-2 w-full mx-10">
              <div
                className={`flex h-8 w-8 px-4 mx-0 items-center justify-center rounded-full ${
                  step >= 1 ? "bg-[#9F8BCF]" : "bg-[#594B7A]"
                }`}
              >
                <span className="text-sm font-medium">1</span>
              </div>
              <div
                className={`h-[4px] w-full mx-0 ${
                  step >= 2 ? "bg-[#6B5993]" : "bg-[#392F4F]"
                }`}
              />
              <div
                className={`flex h-8 w-8 p-4 mx-0 items-center justify-center rounded-full ${
                  step >= 2 ? "bg-[#9F8BCF]" : "bg-[#594B7A]"
                }`}
              >
                <span className="text-sm font-medium ">2</span>
              </div>
              <div
                className={`h-[4px] w-full mx-0 ${
                  step >= 3 ? "bg-[#6B5993]" : "bg-[#392F4F]"
                }`}
              />
              <div
                className={`flex h-8 w-8 p-4 items-center justify-center rounded-full ${
                  step >= 3 ? " bg-[#9F8BCF]" : "bg-[#594B7A]"
                }`}
              >
                <span className="text-sm font-medium">3</span>
              </div>
              <div
                className={`h-[4px] w-full mx-0 ${
                  step >= 4 ? "bg-[#6B5993]" : "bg-[#392F4F]"
                }`}
              />
              <div
                className={`flex h-8 w-8 p-4 items-center justify-center rounded-full ${
                  step >= 4 ? " bg-[#9F8BCF]" : "bg-[#594B7A]"
                }`}
              >
                <span className="text-sm font-medium">4</span>
              </div>
            </div>
          </div>
        </DialogHeader>
        <h2 className="text-2xl text-center font-bold dark:text-white/75 text-black">Wire Transfer</h2>
        {renderStep()}
      </DialogContent>
    </Dialog>
  );
}
